<!-- /templates/inventory/product_list.html -->
{% extends "base.html" %}

{% block title %}Product List{% endblock %}

{% block content %}
    <!-- 0. CUSTOM CSS for Hover Effects (Put this here or in base.html) -->
    <style>
        .transition-all {
            transition: all 0.3s ease-in-out;
            border: 1px solid transparent;
        }
        .hover-shadow:hover {
            transform: translateY(-5px);
            box-shadow: 0 1rem 3rem rgba(0,0,0,.175) !important;
            border-color: #0d6efd !important; /* Bootstrap Primary Color */
        }
        .hover-shadow:hover .card-title a {
            color: #0d6efd !important;
        }
    </style>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Product List</h1>
        <div>
            {% if current_user.group in ['Owner', 'Admin', 'Stock Manager'] %}
                <a href="{{ url_for('add_product') }}" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Add New Product</a>
            {% endif %}
        </div>
    </div>

    <!-- Filter Form (Kept exactly as is) -->
    <div class="accordion mb-4" id="filterAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilter">
                    <i class="fas fa-filter me-2"></i>Search & Filters
                </button>
            </h2>
            <div id="collapseFilter" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#filterAccordion">
                <div class="accordion-body">
                    <form method="get" action="{{ url_for('product_list') }}">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                {{ filter_form.q.label(class="form-label") }}
                                {{ filter_form.q(class="form-control") }}
                            </div>
                            <div class="col-md-3">
                                {{ filter_form.category.label(class="form-label") }}
                                {{ filter_form.category(class="form-select") }}
                            </div>
                            <div class="col-md-2">
                                {{ filter_form.product_status.label(class="form-label") }}
                                {{ filter_form.product_status(class="form-select") }}
                            </div>
                            <div class="col-md-2">
                                {{ filter_form.sort_by.label(class="form-label") }}
                                {{ filter_form.sort_by(class="form-select") }}
                            </div>
                        </div>
                        <div class="mt-3 d-flex">
                            <button class="btn btn-primary" type="submit"><i class="fas fa-search"></i> Apply</button>
                            <a href="{{ url_for('product_list') }}" class="btn btn-secondary ms-2">Reset</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 1. VIEW TOGGLE BUTTONS -->
    <div class="d-flex justify-content-end mb-3">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-secondary active" id="table-view-btn" title="List View"><i class="fas fa-list"></i></button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="card-view-btn" title="Grid View"><i class="fas fa-th-large"></i></button>
        </div>
    </div>

    <!-- 2. TABLE VIEW (Your existing table wrapped in a div) -->
    <div id="table-view">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-3">Name</th>
                                <th>SKU</th>
                                <th>Category</th>
                                <th class="text-center">Stock Status</th>
                                <th class="pe-3">Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in product_list %}
                            <tr>
                                <td class="ps-3">
                                    <a href="{{ url_for('product_detail', sku=product._id) }}" class="text-decoration-none text-dark">
                                        <strong>{{ product.name }}</strong>
                                    </a>
                                    {% if product.status == 'DEACTIVATED' %}<span class="badge bg-secondary ms-2">Deactivated</span>{% endif %}
                                </td>
                                <td>{{ product._id }}</td>
                                <td>{{ product.category_name or "N/A" }}</td>
                                <td class="text-center">
                                    {% if product.quantity > product.reorder_level %}
                                        <span class="badge rounded-pill bg-success">In Stock ({{ product.quantity }})</span>
                                    {% elif product.quantity > 0 %}
                                        <span class="badge rounded-pill bg-warning text-dark">Low Stock ({{ product.quantity }})</span>
                                    {% else %}
                                        <span class="badge rounded-pill bg-danger">Out of Stock</span>
                                    {% endif %}
                                </td>
                                <td class="pe-3">₱{{ "%.2f"|format(product.price|float) }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" class="text-center py-4">No products found matching your criteria.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. GRID VIEW (New Card Design with Hover Effects) -->
    <div id="card-view" style="display: none;">
        <div class="row g-4">
            {% for product in product_list %}
            <div class="col-md-6 col-lg-4 col-xl-3">
                <div class="card h-100 border-0 shadow-sm hover-shadow transition-all">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <span class="badge bg-light text-secondary border">{{ product.category_name or "Uncategorized" }}</span>
                            {% if product.status == 'ACTIVE' %}
                                <span class="badge bg-success bg-opacity-10 text-success border border-success rounded-pill px-2" style="font-size: 0.7rem;">Active</span>
                            {% else %}
                                <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary rounded-pill px-2" style="font-size: 0.7rem;">Inactive</span>
                            {% endif %}
                        </div>
                        
                        <h5 class="card-title fw-bold mb-1">
                            <a href="{{ url_for('product_detail', sku=product._id) }}" class="text-dark text-decoration-none stretched-link">{{ product.name }}</a>
                        </h5>
                        <p class="text-muted small font-monospace mb-3">{{ product._id }}</p>
                        
                        <div class="mt-auto">
                            <h4 class="fw-bold text-primary mb-3">₱{{ "%.2f"|format(product.price|float) }}</h4>
                            
                            <!-- Stock Logic & Progress Bar -->
                            {% set pct = (product.quantity / product.reorder_level * 100)|round|int if product.reorder_level and product.reorder_level > 0 else 100 %}
                            
                            <div class="d-flex justify-content-between align-items-end small mb-1">
                                <span class="{% if product.quantity == 0 %}text-danger fw-bold{% else %}text-muted{% endif %}">
                                    Stock: {{ product.quantity }}
                                </span>
                                
                                {% if product.quantity == 0 %}
                                    <span class="badge bg-danger bg-opacity-10 text-danger border border-danger">Out of Stock</span>
                                {% elif product.quantity <= product.reorder_level %}
                                    <span class="badge bg-warning bg-opacity-10 text-warning border border-warning">Low Stock</span>
                                {% else %}
                                    <span class="badge bg-success bg-opacity-10 text-success border border-success">Healthy Stock</span>
                                {% endif %}
                            </div>

                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar 
                                    {% if product.quantity == 0 %}bg-danger
                                    {% elif product.quantity <= product.reorder_level %}bg-warning
                                    {% else %}bg-success{% endif %}" 
                                     style="width: {% if product.quantity == 0 %}100%{% else %}{{ pct }}%{% endif %}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-12 text-center py-5">
                <p class="text-muted fw-medium">No products found matching your criteria.</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- 5. PAGINATION CONTROLS -->
    {% if total_pages > 1 %}
    <nav aria-label="Page navigation" class="mt-5">
        <ul class="pagination justify-content-center shadow-sm">
            
            <!-- PREVIOUS BUTTON -->
            <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('product_list', page=current_page-1, **request.args.to_dict(flat=True)|dict_exclude('page')) }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>

            <!-- PAGE NUMBERS -->
            <!-- This logic limits the buttons to show nearby pages so it doesn't break if you have 100 pages -->
            {% for p in range(1, total_pages + 1) %}
                <!-- Show first, last, current, and surrounding 2 pages -->
                {% if p == 1 or p == total_pages or (p >= current_page - 2 and p <= current_page + 2) %}
                    <li class="page-item {% if p == current_page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('product_list', page=p, **request.args.to_dict(flat=True)|dict_exclude('page')) }}">
                            {{ p }}
                        </a>
                    </li>
                {% elif p == current_page - 3 or p == current_page + 3 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}

            <!-- NEXT BUTTON -->
            <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('product_list', page=current_page+1, **request.args.to_dict(flat=True)|dict_exclude('page')) }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>

        </ul>
        <div class="text-center text-muted small mt-2">
            Page {{ current_page }} of {{ total_pages }}
        </div>
    </nav>
    {% endif %}

    <!-- 4. JAVASCRIPT FOR TOGGLING -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tableView = document.getElementById('table-view');
            const cardView = document.getElementById('card-view');
            const tableViewBtn = document.getElementById('table-view-btn');
            const cardViewBtn = document.getElementById('card-view-btn');

            function switchView(viewType) {
                if (viewType === 'card') {
                    tableView.style.display = 'none';
                    cardView.style.display = 'block';
                    tableViewBtn.classList.remove('active');
                    cardViewBtn.classList.add('active');
                    localStorage.setItem('flask_product_view', 'card-view'); // Unique key for this project
                } else {
                    cardView.style.display = 'none';
                    tableView.style.display = 'block';
                    cardViewBtn.classList.remove('active');
                    tableViewBtn.classList.add('active');
                    localStorage.setItem('flask_product_view', 'table-view');
                }
            }

            if (tableViewBtn) tableViewBtn.addEventListener('click', () => switchView('table'));
            if (cardViewBtn) cardViewBtn.addEventListener('click', () => switchView('card'));
            
            // Check Local Storage on Load
            const savedPreference = localStorage.getItem('flask_product_view');
            if (savedPreference === 'card-view') switchView('card');
        });
    </script>

{% endblock %}